<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <title>Secretary - Appointment Management</title>
  <link rel="stylesheet" href="sekreter_randevu_yonetimi.css">
</head>

<body>

  <div class="box">
    <h2>Appointment Management</h2>
    <p class="subtitle">View and manage appointments</p>
    <button class="new-appointment-btn">
      ➕ Create New Appointment
    </button>

    <div class="modal" id="appointmentModal">
      <div class="modal-content">

        <h3>Create New Appointment</h3>

        <label>Patient</label>
        <select id="patient">
          <option value="">Select patient</option>
        </select>

        <!-- DEPARTMENT -->
        <label>Department</label>
        <div class="field">
          <select id="department">
            <option value="">Select department</option>
            <option value="kardiyoloji">Cardiology</option>
            <option value="dahiliye">Internal Medicine</option>
            <option value="ortopedi">Orthopedics</option>
            <option value="goz">Ophthalmology</option>
            <option value="noroloji">Neurology</option>
            <option value="cildiye">Dermatology</option>
            <option value="kulak">Ear, Nose and Throat</option>
            <option value="psikiyatri">Psychiatry</option>
          </select>
        </div>

        <!-- DOCTOR -->
        <label>Doctor</label>
        <div class="field">
          <span class="icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2">
              <path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5z" />
              <path d="M2 22v-3c0-3.3 6.7-5 10-5s10 1.7 10 5v3" />
            </svg>
          </span>

          <select id="doctor" disabled>
            <option>Please select a department first</option>
          </select>
        </div>

        <!-- DATE -->
        <label>Date</label>
        <div class="field">
          <span class="icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2">
              <path d="M11 14h1v4" />
              <path d="M16 2v4" />
              <path d="M3 10h18" />
              <path d="M8 2v4" />
              <rect x="3" y="4" width="18" height="18" rx="2" />
            </svg>
          </span>

          <input type="date" id="date" required>
        </div>

        <!-- TIME -->
        <label>Time</label>
        <div class="field">
          <span class="icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2">
              <path d="M12 6v6l4 2" />
              <circle cx="12" cy="12" r="10" />
            </svg>
          </span>

          <select id="time" required>
            <option value="">Select time</option>
          </select>
        </div>

        <div class="modal-actions">
          <button class="cancel" onclick="closeModal()">Cancel</button>
          <button class="save" onclick="saveAppointment()">Save</button>
        </div>

      </div>
    </div>

    <div class="back">
      <a href="sekreter_dashboard.html">← Back to Secretary Dashboard</a>
    </div>
  </div>

  <script>
    // 1. AUTH CHECK
    const userInfo = JSON.parse(localStorage.getItem('userInfo'));
    if (!userInfo || (userInfo.role_name !== 'secretary' && userInfo.role_name !== 'admin')) {
      window.location.href = 'sekreter.html';
    }

    // 2. DOM ELEMENTS
    const modal = document.getElementById("appointmentModal");
    const container = document.querySelector('.box');

    // Modal Inputs
    const patientSelect = document.getElementById("patient");
    const departmentSelect = document.getElementById("department");
    const doctorSelect = document.getElementById("doctor");
    const dateInput = document.getElementById("date");
    const timeSelect = document.getElementById("time");

    let allDoctors = [];
    let allPatients = [];

    // 3. INIT
    window.addEventListener('DOMContentLoaded', async () => {
      document.querySelectorAll('.appointment-card').forEach(e => e.remove());
      await loadAppointments();
      await loadPatients();
      await loadDoctorsData();
    });

    // 4. LOAD & RENDER APPOINTMENTS
    async function loadAppointments() {
      try {
        const res = await fetch('/all-appointments');
        const appointments = await res.json();

        container.querySelectorAll('.appointment-card').forEach(e => e.remove());
        const backLink = document.querySelector('.back');

        appointments.forEach(appt => {
          const card = document.createElement('div');
          card.className = 'appointment-card';

          let statusClass = 'pending';
          let statusText = 'Pending';

          if (appt.status === 'scheduled') { statusClass = 'approved'; statusText = 'Approved'; }
          else if (appt.status === 'cancelled') { statusClass = 'canceled'; statusText = 'Cancelled'; }
          else if (appt.status === 'completed') { statusClass = 'approved'; statusText = 'Completed'; }

          card.innerHTML = `
            <div class="info">
              <p><strong>Patient:</strong> ${appt.patient_name}</p>
              <p><strong>Department:</strong> ${appt.expertise}</p>
              <p><strong>Doctor:</strong> ${appt.doctor_name}</p>
              <p><strong>Date:</strong> ${new Date(appt.appointment_date).toLocaleDateString('tr-TR')}</p>
              <p><strong>Time:</strong> ${appt.start_time.substring(0, 5)}</p>
              <p class="status ${statusClass}">Status: ${statusText}</p>
            </div>
          `;

          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'actions';

          if (appt.status === 'scheduled') {
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cancel';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = () => cancelAppt(appt.appointment_id);
            actionsDiv.appendChild(cancelBtn);
          }

          card.appendChild(actionsDiv);
          container.insertBefore(card, backLink);
        });

      } catch (err) {
        console.error("Appointments could not be loaded:", err);
      }
    }

    // 5. LOAD PATIENTS
    async function loadPatients() {
      try {
        const res = await fetch('/users');
        const users = await res.json();
        allPatients = users.filter(u => u.role === 'patient');

        patientSelect.innerHTML = '<option value="">Select patient</option>';
        allPatients.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.patient_id;
          opt.textContent = `${p.name} (${p.email})`;
          patientSelect.appendChild(opt);
        });
      } catch (err) { console.error(err); }
    }

    // 6. LOAD DOCTORS
    async function loadDoctorsData() {
      try {
        const res = await fetch('/doctors');
        allDoctors = await res.json();
      } catch (err) { console.error(err); }
    }

    // 7. EVENTS
    departmentSelect.addEventListener('change', function () {
      const dept = this.value;
      doctorSelect.innerHTML = '<option value="">Select doctor</option>';
      timeSelect.innerHTML = '<option value="">Select time</option>';
      doctorSelect.disabled = true;

      if (!dept) return;

      const filtered = allDoctors.filter(d => d.expertise.toLowerCase() === dept.toLowerCase());

      if (filtered.length > 0) {
        doctorSelect.disabled = false;
        filtered.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.doctor_id;
          opt.textContent = `${d.first_name} ${d.last_name}`;
          doctorSelect.appendChild(opt);
        });
      } else {
        const opt = document.createElement('option');
        opt.textContent = "No doctor found in this department";
        doctorSelect.appendChild(opt);
      }
    });

    async function updateSlots() {
      timeSelect.innerHTML = '<option value="">Select time</option>';
      const doctorId = doctorSelect.value;
      const dateVal = dateInput.value;

      if (!doctorId || !dateVal) return;

      try {
        const res = await fetch(`/available-slots/?doctor_id=${doctorId}&date=${dateVal}`);
        const slots = await res.json();

        if (slots.length === 0) {
          const opt = document.createElement('option');
          opt.textContent = "No available time";
          timeSelect.appendChild(opt);
          return;
        }

        slots.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.slot_id;
          opt.textContent = `${s.start_time.substring(0, 5)} - ${s.end_time.substring(0, 5)}`;
          timeSelect.appendChild(opt);
        });
      } catch (err) { console.error(err); }
    }

    doctorSelect.addEventListener('change', updateSlots);
    dateInput.addEventListener('change', updateSlots);

    document.querySelector(".new-appointment-btn").addEventListener("click", () => {
      modal.style.display = "flex";
    });

    window.closeModal = function () {
      modal.style.display = "none";
      patientSelect.value = "";
      departmentSelect.value = "";
      doctorSelect.innerHTML = '<option>Please select a department first</option>';
      doctorSelect.disabled = true;
      dateInput.value = "";
      timeSelect.innerHTML = '<option value="">Select time</option>';
    }

    window.saveAppointment = async function () {
      const patientId = patientSelect.value;
      const doctorId = doctorSelect.value;
      const slotId = timeSelect.value;
      const dateVal = dateInput.value;

      if (!patientId || !doctorId || !slotId || !dateVal) {
        alert("Please fill in all fields.");
        return;
      }

      try {
        const res = await fetch('/appointments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            patient_id: parseInt(patientId),
            doctor_id: parseInt(doctorId),
            slot_id: parseInt(slotId),
            appointment_date: dateVal
          })
        });

        const result = await res.json();
        if (res.ok) {
          alert("Appointment created!");
          closeModal();
          loadAppointments();
        } else {
          alert("Error: " + (result.detail || "Could not be created"));
        }
      } catch (err) {
        alert("Connection error: " + err);
      }
    }

    window.cancelAppt = async function (id) {
      if (!confirm("Are you sure you want to cancel the appointment?")) return;

      try {
        const res = await fetch(`/appointments/${id}`, { method: 'DELETE' });
        if (res.ok) {
          alert("Appointment cancelled.");
          await loadAppointments();
        } else {
          alert("Could not be cancelled.");
        }
      } catch (err) { alert(err); }
    }
  </script>
</body>

</html>
