<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <title>My Appointments</title>
  <link rel="stylesheet" href="randevularim.css">
</head>

<body>

  <div class="box">
    <h2>My Appointments</h2>
    <div id="notification" class="notification">
      Your appointment has been cancelled.
    </div>

    <div id="appointments">

      <div class="appointment-card">
        <div class="info">
          <p><strong>Department:</strong> Cardiology</p>
          <p><strong>Doctor:</strong> Dr. Ahmet Yılmaz</p>
          <p><strong>Date:</strong> 20.05.2025</p>
          <p><strong>Time:</strong> 10:30</p>
          <p class="status active">Status: Active</p>
        </div>
        <button class="cancel-btn">Cancel</button>
      </div>

      <div class="appointment-card">
        <div class="info">
          <p><strong>Department:</strong> Internal Medicine</p>
          <p><strong>Doctor:</strong> Dr. Ayşe Demir</p>
          <p><strong>Date:</strong> 10.04.2025</p>
          <p><strong>Time:</strong> 14:00</p>
          <p class="status past">Status: Past</p>
        </div>
        <button class="cancel-btn">Cancel</button>
      </div>

    </div>

    <div class="back">
      <a href="hasta_dashboard.html">← Back to Patient Dashboard</a>
    </div>
  </div>

  <div id="cancelModal" class="modal">
    <div class="modal-content">
      <h3>Do you want to cancel the appointment?</h3>
      <p>This action cannot be undone.</p>

      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeCancelModal()">Dismiss</button>
        <button class="btn-danger" onclick="confirmCancel()">Yes, Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // Kullanıcı bilgilerini al
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');

    if (!userInfo.user_id) {
      alert('Please log in first!');
      window.location.href = 'login.html';
    }

    let selectedAppointmentId = null;
    let selectedCard = null;

    // Sayfa yüklendiğinde randevuları getir
    window.addEventListener('DOMContentLoaded', async () => {
      await loadAppointments();
    });

    async function loadAppointments() {
      try {
        const response = await fetch(`/patients/${userInfo.user_id}/appointments`);
        const appointments = await response.json();

        const container = document.getElementById('appointments');
        container.innerHTML = '';

        if (appointments.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #6b7280;">You do not have any appointments yet.</p>';
          return;
        }

        appointments.forEach(appt => {
          const card = document.createElement('div');
          card.className = 'appointment-card';

          const date = new Date(appt.appointment_date);
          const formattedDate = date.toLocaleDateString('tr-TR');

          const isPast = new Date(appt.appointment_date) < new Date();
          const isCancelled = appt.status === 'cancelled';
          const statusClass = isCancelled ? 'cancelled' : (isPast ? 'past' : 'active');
          const statusText = isCancelled ? 'Cancelled' : (isPast ? 'Past' : 'Active');

          card.innerHTML = `
          <div class="info">
            <p><strong>Department:</strong> ${appt.expertise}</p>
            <p><strong>Doctor:</strong> ${appt.doctor_name}</p>
            <p><strong>Date:</strong> ${formattedDate}</p>
            <p><strong>Time:</strong> ${appt.start_time.substring(0, 5)}</p>
            <p class="status ${statusClass}">Status: ${statusText}</p>
          </div>
          ${!isCancelled && !isPast ? `<button class="cancel-btn" data-id="${appt.appointment_id}">Cancel</button>` : ''}
        `;

          container.appendChild(card);
        });

        document.querySelectorAll('.cancel-btn').forEach(btn => {
          btn.addEventListener('click', function () {
            selectedAppointmentId = this.getAttribute('data-id');
            selectedCard = this.closest('.appointment-card');
            document.getElementById('cancelModal').style.display = 'flex';
          });
        });

      } catch (error) {
        console.error('Appointments could not be loaded:', error);
        document.getElementById('appointments').innerHTML =
          '<p style="text-align: center; color: #ef4444;">An error occurred while loading appointments!</p>';
      }
    }

    function closeCancelModal() {
      document.getElementById('cancelModal').style.display = 'none';
    }

    async function confirmCancel() {
      if (!selectedAppointmentId) return;

      try {
        const response = await fetch(`/appointments/${selectedAppointmentId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok) {
          if (selectedCard) {
            selectedCard.remove();
          }
          closeCancelModal();
          showNotification();
          await loadAppointments();
        } else {
          alert('Appointment could not be cancelled: ' + (data.detail || 'Unknown error'));
        }
      } catch (error) {
        alert('Connection error: ' + error.message);
      }
    }

    function showNotification() {
      const notif = document.getElementById('notification');
      notif.style.display = 'block';

      setTimeout(() => {
        notif.style.display = 'none';
      }, 2500);
    }
  </script>

</body>

</html>
