<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <title>Book Appointment</title>
  <link rel="stylesheet" href="randevu.css">

  <style>
    * {
      box-sizing: border-box;
      font-family: Arial, Helvetica, sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, #eef2ff, #f4f7fb);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .box {
      width: 460px;
      background: #fff;
      padding: 40px;
      border-radius: 22px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
    }

    h2 {
      text-align: center;
      margin-bottom: 30px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .field {
      position: relative;
      margin-bottom: 22px;
    }

    .field input,
    .field select {
      width: 100%;
      height: 48px;
      padding-left: 48px;
      padding-right: 40px;
      border-radius: 14px;
      border: 1.5px solid #d1d5db;
      font-size: 15px;
    }

    .field input:focus,
    .field select:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.18);
    }

    .icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
    }

    select {
      appearance: none;
      background-image: url("data:image/svg+xml;utf8,<svg fill='%236366f1' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'><path d='M5.5 7l4.5 5 4.5-5'/></svg>");
      background-repeat: no-repeat;
      background-position: right 16px center;
      background-size: 18px;
    }

    button {
      width: 100%;
      height: 48px;
      background: #6366f1;
      color: white;
      border: none;
      border-radius: 16px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }

    button:hover {
      background: #4f46e5;
    }

    .back {
      margin-top: 24px;
      text-align: center;
    }

    .back a {
      color: #6366f1;
      text-decoration: none;
      font-weight: bold;
    }
  </style>
</head>

<body>

  <div class="box">
    <h2>Book Appointment</h2>

    <form id="appointmentForm">

      <!-- DEPARTMENT -->
      <label>Department</label>
      <div class="field">
        <span class="icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 18V5" />
            <path d="M15 13a4.17 4.17 0 0 1-3-4 4.17 4.17 0 0 1-3 4" />
            <path d="M17.598 6.5A3 3 0 1 0 12 5a3 3 0 1 0-5.598 1.5" />
            <path d="M17.997 5.125a4 4 0 0 1 2.526 5.77" />
            <path d="M18 18a4 4 0 0 0 2-7.464" />
            <path d="M19.967 17.483A4 4 0 1 1 12 18a4 4 0 1 1-7.967-.517" />
            <path d="M6 18a4 4 0 0 1-2-7.464" />
            <path d="M6.003 5.125a4 4 0 0 0-2.526 5.77" />
          </svg>
        </span>

        <select id="department">
          <option value="">Select Department</option>
          <option value="kardiyoloji">Cardiology</option>
          <option value="dahiliye">Internal Medicine</option>
          <option value="ortopedi">Orthopedics</option>
          <option value="goz">Ophthalmology</option>
          <option value="noroloji">Neurology</option>
          <option value="cildiye">Dermatology</option>
          <option value="kulak">Ear, Nose and Throat</option>
          <option value="psikiyatri">Psychiatry</option>
        </select>
      </div>

      <!-- DOCTOR -->
      <label>Doctor</label>
      <div class="field">
        <span class="icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2">
            <path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5z" />
            <path d="M2 22v-3c0-3.3 6.7-5 10-5s10 1.7 10 5v3" />
          </svg>
        </span>

        <select id="doctor" disabled>
          <option>Please select a department first</option>
        </select>
      </div>

      <!-- DATE -->
      <label>Date</label>
      <div class="field">
        <span class="icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2">
            <path d="M11 14h1v4" />
            <path d="M16 2v4" />
            <path d="M3 10h18" />
            <path d="M8 2v4" />
            <rect x="3" y="4" width="18" height="18" rx="2" />
          </svg>
        </span>

        <input type="date" id="date" required>
      </div>

      <!-- TIME -->
      <label>Time</label>
      <div class="field">
        <span class="icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2">
            <path d="M12 6v6l4 2" />
            <circle cx="12" cy="12" r="10" />
          </svg>
        </span>

        <select id="time" required>
          <option value="">Select Time</option>
          <option>09:00</option>
          <option>09:30</option>
          <option>10:00</option>
          <option>10:30</option>
          <option>11:00</option>
          <option>11:30</option>
        </select>
      </div>

      <button>Book Appointment</button>
    </form>

    <div class="back">
      <a href="hasta_dashboard.html">← Back to Patient Dashboard</a>
    </div>

    <script>
      const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');

      if (!userInfo.user_id) {
        alert('Please log in first!');
        window.location.href = 'login.html';
      }

      let allDoctors = [];

      window.addEventListener('DOMContentLoaded', async () => {
        await loadDoctors();
      });

      async function loadDoctors() {
        try {
          const response = await fetch('/doctors');
          allDoctors = await response.json();
        } catch (error) {
          console.error('Doctors could not be loaded:', error);
          alert('An error occurred while loading doctors!');
        }
      }

      const department = document.getElementById("department");
      const doctorSelect = document.getElementById("doctor");
      const dateInput = document.getElementById("date");
      const timeSelect = document.getElementById("time");

      department.addEventListener("change", () => {
        doctorSelect.innerHTML = "<option>Select a doctor</option>";
        doctorSelect.disabled = true;
        timeSelect.innerHTML = "<option value=''>Select Time</option>";

        const selectedDept = department.value;

        if (selectedDept && allDoctors.length > 0) {
          const filteredDoctors = allDoctors.filter(doc =>
            doc.expertise.toLowerCase().includes(selectedDept.toLowerCase()) ||
            selectedDept.toLowerCase().includes(doc.expertise.toLowerCase())
          );

          if (filteredDoctors.length > 0) {
            filteredDoctors.forEach(doc => {
              const opt = document.createElement("option");
              opt.value = doc.doctor_id;
              opt.textContent = `Dr. ${doc.first_name} ${doc.last_name}`;
              doctorSelect.appendChild(opt);
            });
            doctorSelect.disabled = false;
          } else {
            allDoctors.forEach(doc => {
              const opt = document.createElement("option");
              opt.value = doc.doctor_id;
              opt.textContent = `Dr. ${doc.first_name} ${doc.last_name}`;
              doctorSelect.appendChild(opt);
            });
            doctorSelect.disabled = false;
          }
        }
      });

      async function loadAvailableSlots() {
        const doctorId = doctorSelect.value;
        const date = dateInput.value;

        if (!doctorId || !date) {
          return;
        }

        try {
          const response = await fetch(`/available-slots/?doctor_id=${doctorId}&date=${date}`);
          const slots = await response.json();

          timeSelect.innerHTML = "<option value=''>Select Time</option>";

          if (slots.length === 0) {
            timeSelect.innerHTML = "<option value=''>No available time on this date</option>";
            return;
          }

          slots.forEach(slot => {
            const opt = document.createElement("option");
            opt.value = slot.slot_id;
            opt.textContent = `${slot.start_time.substring(0, 5)} - ${slot.end_time.substring(0, 5)}`;
            timeSelect.appendChild(opt);
          });
        } catch (error) {
          console.error('Available slots could not be loaded:', error);
          timeSelect.innerHTML = "<option value=''>An error occurred</option>";
        }
      }

      doctorSelect.addEventListener("change", loadAvailableSlots);
      dateInput.addEventListener("change", loadAvailableSlots);

      document.getElementById("appointmentForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const departmentSelect = document.getElementById("department");
        const departmentText = departmentSelect.options[departmentSelect.selectedIndex].text;
        const doctorId = doctorSelect.value;
        const doctorText = doctorSelect.options[doctorSelect.selectedIndex].text;
        const date = dateInput.value;
        const slotId = timeSelect.value;
        const timeText = timeSelect.options[timeSelect.selectedIndex].text;

        if (!departmentText || !doctorId || !date || !slotId) {
          alert("Please fill in all fields.");
          return;
        }

        try {
          const response = await fetch('/appointments', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              patient_id: userInfo.user_id,
              doctor_id: parseInt(doctorId),
              slot_id: parseInt(slotId),
              appointment_date: date
            })
          });

          const data = await response.json();

          if (response.ok) {
            document.getElementById("m-department").innerText = departmentText;
            document.getElementById("m-doctor").innerText = doctorText;
            document.getElementById("m-date").innerText = date;
            document.getElementById("m-time").innerText = timeText;

            document.getElementById("successModal").style.display = "flex";
          } else {
            alert('Appointment could not be created: ' + (data.detail || 'Unknown error'));
          }
        } catch (error) {
          alert('Connection error: ' + error.message);
        }
      });

      function closeModal() {
        document.getElementById("successModal").style.display = "none";
        window.location.href = "hasta_dashboard.html";
      }
    </script>

    <div class="modal" id="successModal">
      <div class="modal-content">
        <h3>✅ Your Appointment Has Been Created</h3>

        <p><strong>Department:</strong> <span id="m-department"></span></p>
        <p><strong>Doctor:</strong> <span id="m-doctor"></span></p>
        <p><strong>Date:</strong> <span id="m-date"></span></p>
        <p><strong>Time:</strong> <span id="m-time"></span></p>

        <button onclick="closeModal()">OK</button>
      </div>
    </div>

</body>

</html>
