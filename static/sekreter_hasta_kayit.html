<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <title>Secretary - Patient Registration</title>
  <link rel="stylesheet" href="sekreter_hasta_kayit.css">
</head>

<body>

  <div class="box">
    <h2>New Patient Registration</h2>
    <p class="subtitle">Please enter patient information</p>

    <form id="patientForm">

      <label>First Name</label>
      <input type="text" required placeholder="Patient first name">

      <label>Last Name</label>
      <input type="text" required placeholder="Patient last name">

      <label>Email</label>
      <input type="email" required placeholder="example@mail.com">

      <label>Phone</label>
      <input type="tel" required placeholder="05xx xxx xx xx">

      <button type="submit">Save Patient</button>
    </form>

    <div class="back">
      <a href="sekreter_dashboard.html">← Back to Secretary Dashboard</a>
    </div>
  </div>

  <!-- SUCCESS POPUP -->
  <div class="modal" id="successModal">
    <div class="modal-content">
      <h3>✅ Registration Successful</h3>
      <p>The patient has been successfully added to the system.</p>
      <p>The user password has been sent to the phone number.</p>
      <button onclick="closeModal()">OK</button>
    </div>
  </div>

  <script>
    // Auth Check
    const userInfo = JSON.parse(localStorage.getItem('userInfo'));
    if (!userInfo || (userInfo.role_name !== 'secretary' && userInfo.role_name !== 'admin')) {
      window.location.href = 'sekreter.html';
    }

    const form = document.getElementById("patientForm");
    const modal = document.getElementById("successModal");

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const inputs = form.querySelectorAll('input');
      const first_name = inputs[0].value.trim();
      const last_name = inputs[1].value.trim();
      const email = inputs[2].value.trim();
      const phone = inputs[3].value.trim();

      // Default password
      const password = "123";

      try {
        const response = await fetch('/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email,
            password,
            first_name,
            last_name,
            phone
          })
        });

        if (response.ok) {
          modal.style.display = "flex";
          form.reset();
        } else {
          const err = await response.json();
          alert("Registration failed: " + (err.detail || "An error occurred"));
        }
      } catch (error) {
        alert("Connection error: " + error);
      }
    });

    function closeModal() {
      modal.style.display = "none";
    }
  </script>

</body>

</html>
