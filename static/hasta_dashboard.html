<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <title>Patient Dashboard</title>
  <link rel="stylesheet" href="dashboard.css">
</head>

<body>

  <div class="dashboard">
    <h2>WELCOME</h2>
    <p class="welcome" id="welcomeText">Dear Patient;</p>

    <div class="description">
      From here, you can book appointments and view your existing appointments.
    </div>

    <div class="cards">
      <a href="randevu_al.html" class="card">
        <div class="icon">ðŸ“…</div>
        <div class="title">Book Appointment</div>
      </a>

      <a href="randevularim.html" class="card">
        <div class="icon">ðŸ“‹</div>
        <div class="title">My Appointments</div>
      </a>

      <a href="#" onclick="openPasswordModal(); return false;" class="card">
        <div class="icon">ðŸ”‘</div>
        <div class="title">Change Password</div>
      </a>

      <a href="#" onclick="logout(); return false;" class="card">
        <div class="icon">ðŸšª</div>
        <div class="title">Log Out</div>
      </a>
    </div>
  </div>

  <!-- PASSWORD MODAL -->
  <div id="passwordModal" class="modal"
    style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.4);">
    <div class="modal-content"
      style="background-color:#fefefe; margin:15% auto; padding:20px; border:1px solid #888; width:300px; border-radius:10px; text-align: left;">
      <span class="close" onclick="closePasswordModal()"
        style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
      <h2 style="margin-top:0; color: #333;">Change Password</h2>
      <input type="password" id="currentPass" placeholder="Current Password"
        style="width:100%; margin-bottom:10px; padding:10px; box-sizing: border-box;">
      <input type="password" id="newPass" placeholder="New Password"
        style="width:100%; margin-bottom:10px; padding:10px; box-sizing: border-box;">
      <input type="password" id="confirmPass" placeholder="Confirm New Password"
        style="width:100%; margin-bottom:10px; padding:10px; box-sizing: border-box;">
      <button onclick="changePassword()"
        style="width:100%; padding:10px; background-color:#4f46e5; color:white; border:none; border-radius:5px; cursor:pointer;">Update</button>
      <p id="passMsg" style="margin-top:10px; font-size:14px; text-align: center;"></p>
    </div>
  </div>

  <script>
    // KullanÄ±cÄ± bilgilerini al ve hoÅŸgeldin mesajÄ±nÄ± gÃ¼ncelle
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');

    if (userInfo.first_name && userInfo.last_name) {
      document.getElementById('welcomeText').textContent =
        `Dear ${userInfo.first_name} ${userInfo.last_name};`;
    }

    function logout() {
      localStorage.removeItem('userInfo');
      window.location.href = '/';
    }

    // Modal functions
    function openPasswordModal() {
      if (!userInfo.user_id) {
        alert("Please log in first.");
        return;
      }
      document.getElementById('passwordModal').style.display = 'block';
    }

    function closePasswordModal() {
      document.getElementById('passwordModal').style.display = 'none';
      document.getElementById('passMsg').textContent = '';
      document.getElementById('currentPass').value = '';
      document.getElementById('newPass').value = '';
      document.getElementById('confirmPass').value = '';
    }

    async function changePassword() {
      const currentPass = document.getElementById('currentPass').value;
      const newPass = document.getElementById('newPass').value;
      const confirmPass = document.getElementById('confirmPass').value;
      const msg = document.getElementById('passMsg');

      if (!currentPass || !newPass || !confirmPass) {
        msg.style.color = 'red';
        msg.textContent = 'Please fill in all fields.';
        return;
      }

      if (newPass !== confirmPass) {
        msg.style.color = 'red';
        msg.textContent = 'New passwords do not match.';
        return;
      }

      try {
        const response = await fetch(`/users/${userInfo.user_id}/password`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            current_password: currentPass,
            new_password: newPass
          })
        });

        const data = await response.json();

        if (response.ok) {
          msg.style.color = 'green';
          msg.textContent = data.message;
          setTimeout(closePasswordModal, 2000);
        } else {
          msg.style.color = 'red';
          msg.textContent = data.detail || 'Password could not be updated';
        }
      } catch (error) {
        msg.style.color = 'red';
        msg.textContent = 'Connection error';
      }
    }
  </script>

</body>

</html>
